{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Eli Forbes - v-eliforbes@microsoft.com",
    "comments": "Solution template for Cisco Umbrella"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[parameters('location')]",
      "metadata": {
        "description": "Region to deploy solution resources"
      }
    },
    "workspace": {
      "defaultValue": "<Enter Log Analytics Workspace>",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Workspace name for Log Analytics where Sentinel is setup"
      }
    },
    "formattedTimeNow": {
      "type": "string",
      "defaultValue": "[utcNow('g')]",
      "metadata": {
        "description": "Appended to workbook displayNames to make them unique"
      }
    },
    "workbook1-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the workbook"
      }
    },
    "workbook1-name": {
      "type": "string",
      "defaultValue": "Cisco Umbrella",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    },
    "analytic1-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic2-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic3-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic4-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic5-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic6-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic7-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic8-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic9-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic10-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    }
  },
  "variables": {
    "workspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace'))]",
    "deploymentApiVersion": "2022-09-01",
    "workbookApiVersion": "2022-04-01",
    "alertRuleApiVersion": "2023-11-01",
    "savedSearchApiVersion": "2022-10-01"
  },
  "resources": [
    {
      "name": "pid-c831fa37-c174-4c50-a094-e820557d868e-partnercenter",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "[variables('deploymentApiVersion')]",
      "properties": {
        "mode": "Incremental",
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "resources": []
        }
      }
    },
    {
      "type": "Microsoft.SecurityInsights/alertRules",
      "apiVersion": "[variables('alertRuleApiVersion')]",
      "name": "[parameters('analytic1-id')]",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[variables('workspaceResourceId')]"
      ],
      "properties": {
        "description": "IP addresses of broadband links that usually indicates users attempting to access their home network, for example for a remote session to a home computer.",
        "displayName": "Cisco Umbrella - Connection to non-corporate private network",
        "enabled": false,
        "query": "let lbtime = 10m;\nCisco_Umbrella\n| where TimeGenerated > ago(lbtime)\n| where EventType == 'proxylogs'\n| where DvcAction =~ 'Allowed'\n| where UrlCategory contains 'Adult Themes' or\n      UrlCategory contains 'Adware' or\n      UrlCategory contains 'Alcohol' or\n      UrlCategory contains 'Illegal Downloads' or\n      UrlCategory contains 'Drugs' or\n      UrlCategory contains 'Child Abuse Content' or\n      UrlCategory contains 'Hate/Discrimination' or\n      UrlCategory contains 'Nudity' or\n      UrlCategory contains 'Pornography' or\n      UrlCategory contains 'Proxy/Anonymizer' or\n      UrlCategory contains 'Sexuality' or\n      UrlCategory contains 'Tasteless' or\n      UrlCategory contains 'Terrorism' or\n      UrlCategory contains 'Web Spam' or\n      UrlCategory contains 'German Youth Protection' or\n      UrlCategory contains 'Illegal Activities' or\n      UrlCategory contains 'Lingerie/Bikini' or\n      UrlCategory contains 'Weapons'\n| project TimeGenerated, SrcIpAddr, Identities\n| extend IPCustomEntity = SrcIpAddr\n| extend AccountCustomEntity = Identities\n",
        "queryFrequency": "PT10M",
        "queryPeriod": "PT10M",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "CommandandControl",
          "Exfiltration"
        ],
        "entityMappings": [
          {
            "entityType": "Account",
            "fieldMappings": [
              {
                "identifier": "FullName",
                "columnName": "AccountCustomEntity"
              }
            ]
          },
          {
            "entityType": "IP",
            "fieldMappings": [
              {
                "identifier": "Address",
                "columnName": "IPCustomEntity"
              }
            ]
          }
        ]
      }
    },
    {
      "type": "Microsoft.SecurityInsights/alertRules",
      "apiVersion": "[variables('alertRuleApiVersion')]",
      "name": "[parameters('analytic2-id')]",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[variables('workspaceResourceId')]"
      ],
      "properties": {
        "description": "Detects first connection to an unpopular website (possible malicious payload delivery).",
        "displayName": "Cisco Umbrella - Connection to Unpopular Website Detected",
        "enabled": false,
        "query": "let domain_lookBack= 14d;\nlet timeframe = 1d;\nlet top_million_list = Cisco_Umbrella\n| where EventType == \"proxylogs\"\n| where TimeGenerated > ago(domain_lookBack) and TimeGenerated < ago(timeframe)\n| extend Hostname = parse_url(UrlOriginal)[\"Host\"]\n| summarize count() by tostring(Hostname)\n| top 1000000 by count_\n| summarize make_list(Hostname);\nCisco_Umbrella\n| where EventType == \"proxylogs\"\n| where TimeGenerated > ago(timeframe)\n| extend Hostname = parse_url(UrlOriginal)[\"Host\"]\n| where Hostname !in (top_million_list)\n| extend Message = \"Connect to unpopular website (possible malicious payload delivery)\"\n| project Message, SrcIpAddr, DstIpAddr,UrlOriginal, TimeGenerated\n| extend IpCustomEntity = SrcIpAddr, UrlCustomEntity = UrlOriginal\n",
        "queryFrequency": "P1D",
        "queryPeriod": "P14D",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "CommandandControl"
        ],
        "entityMappings": [
          {
            "entityType": "IP",
            "fieldMappings": [
              {
                "identifier": "Address",
                "columnName": "IpCustomEntity"
              }
            ]
          },
          {
            "entityType": "URL",
            "fieldMappings": [
              {
                "identifier": "Url",
                "columnName": "UrlCustomEntity"
              }
            ]
          }
        ]
      }
    },
    {
      "type": "Microsoft.SecurityInsights/alertRules",
      "apiVersion": "[variables('alertRuleApiVersion')]",
      "name": "[parameters('analytic3-id')]",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[variables('workspaceResourceId')]"
      ],
      "properties": {
        "description": "Detects suspicious user agent strings used by crypto miners in proxy logs.",
        "displayName": "Cisco Umbrella - Crypto Miner User-Agent Detected",
        "enabled": false,
        "query": "let timeframe = 15m;\nCisco_Umbrella\n| where EventType == \"proxylogs\"\n| where TimeGenerated > ago(timeframe)\n| where HttpUserAgentOriginal contains \"XMRig\" or HttpUserAgentOriginal contains \"ccminer\"\n| extend Message = \"Crypto Miner User Agent\"\n| project Message, SrcIpAddr, DstIpAddr, UrlOriginal, TimeGenerated,HttpUserAgentOriginal\n| extend IpCustomEntity = SrcIpAddr, UrlCustomEntity = UrlOriginal\n",
        "queryFrequency": "PT15M",
        "queryPeriod": "PT15M",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "CommandandControl"
        ],
        "entityMappings": [
          {
            "entityType": "IP",
            "fieldMappings": [
              {
                "identifier": "Address",
                "columnName": "IpCustomEntity"
              }
            ]
          },
          {
            "entityType": "URL",
            "fieldMappings": [
              {
                "identifier": "Url",
                "columnName": "UrlCustomEntity"
              }
            ]
          }
        ]
      }
    },
    {
      "type": "Microsoft.SecurityInsights/alertRules",
      "apiVersion": "[variables('alertRuleApiVersion')]",
      "name": "[parameters('analytic4-id')]",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[variables('workspaceResourceId')]"
      ],
      "properties": {
        "description": "Rule helps to detect empty and unusual user agent indicating web browsing activity by an unusual process other than a web browser.",
        "displayName": "Cisco Umbrella - Empty User Agent Detected",
        "enabled": false,
        "query": "let timeframe = 15m;\nCisco_Umbrella\n| where EventType == \"proxylogs\"\n| where TimeGenerated > ago(timeframe)\n| where HttpUserAgentOriginal == ''\n| extend Message = \"Empty User Agent\"\n| project Message, SrcIpAddr, DstIpAddr, UrlOriginal, TimeGenerated\n| extend IpCustomEntity = SrcIpAddr, UrlCustomEntity = UrlOriginal\n",
        "queryFrequency": "PT15M",
        "queryPeriod": "PT15M",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "CommandandControl"
        ],
        "entityMappings": [
          {
            "entityType": "IP",
            "fieldMappings": [
              {
                "identifier": "Address",
                "columnName": "IpCustomEntity"
              }
            ]
          },
          {
            "entityType": "URL",
            "fieldMappings": [
              {
                "identifier": "Url",
                "columnName": "UrlCustomEntity"
              }
            ]
          }
        ]
      }
    },
    {
      "type": "Microsoft.SecurityInsights/alertRules",
      "apiVersion": "[variables('alertRuleApiVersion')]",
      "name": "[parameters('analytic5-id')]",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[variables('workspaceResourceId')]"
      ],
      "properties": {
        "description": "Detects suspicious user agent strings used by known hack tools",
        "displayName": "Cisco Umbrella - Hack Tool User-Agent Detected",
        "enabled": false,
        "query": "let timeframe = 15m;\nlet user_agents=dynamic([\n                          '(hydra)',\n                          ' arachni/',\n                          ' BFAC ',\n                          ' brutus ',\n                          ' cgichk ',\n                          'core-project/1.0',\n                          ' crimscanner/',\n                          'datacha0s',\n                          'dirbuster',\n                          'domino hunter',\n                          'dotdotpwn',\n                          'FHScan Core',\n                          'floodgate',\n                          'get-minimal',\n                          'gootkit auto-rooter scanner',\n                          'grendel-scan',\n                          ' inspath ',\n                          'internet ninja',\n                          'jaascois',\n                          ' zmeu ',\n                          'masscan',\n                          ' metis ',\n                          'morfeus fucking scanner',\n                          'n-stealth',\n                          'nsauditor',\n                          'pmafind',\n                          'security scan',\n                          'springenwerk',\n                          'teh forest lobster',\n                          'toata dragostea',\n                          ' vega/',\n                          'voideye',\n                          'webshag',\n                          'webvulnscan',\n                          ' whcc/',\n                          ' Havij',\n                          'absinthe',\n                          'bsqlbf',\n                          'mysqloit',\n                          'pangolin',\n                          'sql power injector',\n                          'sqlmap',\n                          'sqlninja',\n                          'uil2pn',\n                          'ruler',\n                          'Mozilla/5.0 (Windows; U; Windows NT 5.1; pt-PT; rv:1.9.1.2) Gecko/20090729 Firefox/3.5.2 (.NET CLR 3.5.30729)'\n                          ]);\nCisco_Umbrella\n| where EventType == \"proxylogs\"\n| where TimeGenerated > ago(timeframe)\n| where HttpUserAgentOriginal has_any (user_agents)\n| extend Message = \"Hack Tool User Agent\"\n| project Message, SrcIpAddr, DstIpAddr, UrlOriginal, TimeGenerated, HttpUserAgentOriginal\n| extend IpCustomEntity = SrcIpAddr, UrlCustomEntity = UrlOriginal\n",
        "queryFrequency": "PT15M",
        "queryPeriod": "PT15M",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "CommandandControl"
        ],
        "entityMappings": [
          {
            "entityType": "IP",
            "fieldMappings": [
              {
                "identifier": "Address",
                "columnName": "IpCustomEntity"
              }
            ]
          },
          {
            "entityType": "URL",
            "fieldMappings": [
              {
                "identifier": "Url",
                "columnName": "UrlCustomEntity"
              }
            ]
          }
        ]
      }
    },
    {
      "type": "Microsoft.SecurityInsights/alertRules",
      "apiVersion": "[variables('alertRuleApiVersion')]",
      "name": "[parameters('analytic6-id')]",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[variables('workspaceResourceId')]"
      ],
      "properties": {
        "description": "Rule helps to detect Powershell user-agent activity by an unusual process other than a web browser.",
        "displayName": "Cisco Umbrella - Windows PowerShell User-Agent Detected",
        "enabled": false,
        "query": "let timeframe = 15m;\nCisco_Umbrella\n| where EventType == \"proxylogs\"\n| where TimeGenerated > ago(timeframe)\n| where HttpUserAgentOriginal contains \"WindowsPowerShell\"\n| extend Message = \"Windows PowerShell User Agent\"\n| project Message, SrcIpAddr, DstIpAddr, UrlOriginal, TimeGenerated,HttpUserAgentOriginal\n| extend IpCustomEntity = SrcIpAddr, UrlCustomEntity = UrlOriginal\n",
        "queryFrequency": "PT15M",
        "queryPeriod": "PT15M",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "CommandandControl",
          "DefenseEvasion"
        ],
        "entityMappings": [
          {
            "entityType": "IP",
            "fieldMappings": [
              {
                "identifier": "Address",
                "columnName": "IpCustomEntity"
              }
            ]
          },
          {
            "entityType": "URL",
            "fieldMappings": [
              {
                "identifier": "Url",
                "columnName": "UrlCustomEntity"
              }
            ]
          }
        ]
      }
    },
    {
      "type": "Microsoft.SecurityInsights/alertRules",
      "apiVersion": "[variables('alertRuleApiVersion')]",
      "name": "[parameters('analytic7-id')]",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[variables('workspaceResourceId')]"
      ],
      "properties": {
        "description": "Rule helps to detect a rare user-agents indicating web browsing activity by an unusual process other than a web browser.",
        "displayName": "Cisco Umbrella - Rare User Agent Detected",
        "enabled": false,
        "query": "let lookBack = 14d;\nlet timeframe = 1d;\nlet user_agents_list = Cisco_Umbrella\n| where EventType == \"proxylogs\"\n| where TimeGenerated > ago(lookBack) and TimeGenerated < ago(timeframe)\n| summarize count() by HttpUserAgentOriginal\n| summarize make_list(HttpUserAgentOriginal);\nCisco_Umbrella\n| where EventType == \"proxylogs\"\n| where TimeGenerated > ago(timeframe)\n| where HttpUserAgentOriginal !in (user_agents_list)\n| extend Message = \"Rare User Agent\"\n| project Message, SrcIpAddr, DstIpAddr, UrlOriginal, TimeGenerated, HttpUserAgentOriginal\n| extend IpCustomEntity = SrcIpAddr, UrlCustomEntity = UrlOriginal\n",
        "queryFrequency": "P1D",
        "queryPeriod": "P14D",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "CommandandControl"
        ],
        "entityMappings": [
          {
            "entityType": "IP",
            "fieldMappings": [
              {
                "identifier": "Address",
                "columnName": "IpCustomEntity"
              }
            ]
          },
          {
            "entityType": "URL",
            "fieldMappings": [
              {
                "identifier": "Url",
                "columnName": "UrlCustomEntity"
              }
            ]
          }
        ]
      }
    },
    {
      "type": "Microsoft.SecurityInsights/alertRules",
      "apiVersion": "[variables('alertRuleApiVersion')]",
      "name": "[parameters('analytic8-id')]",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[variables('workspaceResourceId')]"
      ],
      "properties": {
        "description": "It is reccomended that these Categories shoud be blocked by policies because they provide harmful/malicious content..",
        "displayName": "Cisco Umbrella - Request Allowed to harmful/malicious URI category",
        "enabled": false,
        "query": "let lbtime = 10m;\nCisco_Umbrella\n| where TimeGenerated > ago(lbtime)\n| where EventType == 'proxylogs'\n| where DvcAction =~ 'Allowed'\n| where UrlCategory contains 'Adult Themes' or\n      UrlCategory contains 'Adware' or\n      UrlCategory contains 'Alcohol' or\n      UrlCategory contains 'Illegal Downloads' or\n      UrlCategory contains 'Drugs' or\n      UrlCategory contains 'Child Abuse Content' or\n      UrlCategory contains 'Hate/Discrimination' or\n      UrlCategory contains 'Nudity' or\n      UrlCategory contains 'Pornography' or\n      UrlCategory contains 'Proxy/Anonymizer' or\n      UrlCategory contains 'Sexuality' or\n      UrlCategory contains 'Tasteless' or\n      UrlCategory contains 'Terrorism' or\n      UrlCategory contains 'Web Spam' or\n      UrlCategory contains 'German Youth Protection' or\n      UrlCategory contains 'Illegal Activities' or\n      UrlCategory contains 'Lingerie/Bikini' or\n      UrlCategory contains 'Weapons'\n| project TimeGenerated, SrcIpAddr, Identities\n| extend IPCustomEntity = SrcIpAddr\n| extend AccountCustomEntity = Identities\n",
        "queryFrequency": "PT10M",
        "queryPeriod": "PT10M",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "CommandandControl",
          "InitialAccess"
        ],
        "entityMappings": [
          {
            "entityType": "IP",
            "fieldMappings": [
              {
                "identifier": "Address",
                "columnName": "IpCustomEntity"
              }
            ]
          },
          {
            "entityType": "URL",
            "fieldMappings": [
              {
                "identifier": "Url",
                "columnName": "UrlCustomEntity"
              }
            ]
          }
        ]
      }
    },
    {
      "type": "Microsoft.SecurityInsights/alertRules",
      "apiVersion": "[variables('alertRuleApiVersion')]",
      "name": "[parameters('analytic9-id')]",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[variables('workspaceResourceId')]"
      ],
      "properties": {
        "description": "Detects request to potentially harmful file types (.ps1, .bat, .vbs, etc.).",
        "displayName": "Cisco Umbrella - Request to blocklisted file type",
        "enabled": false,
        "query": "let file_ext_blocklist = dynamic(['.ps1', '.vbs', '.bat', '.scr']);\nlet lbtime = 10m;\nCisco_Umbrella\n| where TimeGenerated > ago(lbtime)\n| where EventType == 'proxylogs'\n| where DvcAction =~ 'Allowed'\n| extend file_ext = extract(@'.*(\\.\\w+)$', 1, UrlOriginal)\n| extend Filename = extract(@'.*\\/*\\/(.*\\.\\w+)$', 1, UrlOriginal)\n| where file_ext in (file_ext_blocklist)\n| project TimeGenerated, SrcIpAddr, Identities, Filename\n| extend IPCustomEntity = SrcIpAddr\n| extend AccountCustomEntity = Identities\n",
        "queryFrequency": "PT10M",
        "queryPeriod": "PT10M",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "InitialAccess"
        ],
        "entityMappings": [
          {
            "entityType": "IP",
            "fieldMappings": [
              {
                "identifier": "Address",
                "columnName": "IpCustomEntity"
              }
            ]
          },
          {
            "entityType": "URL",
            "fieldMappings": [
              {
                "identifier": "Url",
                "columnName": "UrlCustomEntity"
              }
            ]
          }
        ]
      }
    },
    {
      "type": "Microsoft.SecurityInsights/alertRules",
      "apiVersion": "[variables('alertRuleApiVersion')]",
      "name": "[parameters('analytic10-id')]",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[variables('workspaceResourceId')]"
      ],
      "properties": {
        "description": "Malware can use IP address to communicate with C2.",
        "displayName": "Cisco Umbrella - URI contains IP address",
        "enabled": false,
        "query": "let lbtime = 10m;\nCisco_Umbrella\n| where TimeGenerated > ago(lbtime)\n| where EventType == 'proxylogs'\n| where DvcAction =~ 'Allowed'\n| where UrlOriginal matches regex @'\\Ahttp:\\/\\/\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}.*'\n| project TimeGenerated, SrcIpAddr, Identities\n| extend IPCustomEntity = SrcIpAddr\n| extend AccountCustomEntity = Identities\n",
        "queryFrequency": "PT10M",
        "queryPeriod": "PT10M",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "CommandandControl"
        ],
        "entityMappings": [
          {
            "entityType": "IP",
            "fieldMappings": [
              {
                "identifier": "Address",
                "columnName": "IpCustomEntity"
              }
            ]
          },
          {
            "entityType": "URL",
            "fieldMappings": [
              {
                "identifier": "Url",
                "columnName": "UrlCustomEntity"
              }
            ]
          }
        ]
      }
    },
    {
      "type": "Microsoft.Insights/workbooks",
      "name": "[parameters('workbook1-id')]",
      "location": "[parameters('workspace-location')]",
      "kind": "shared",
      "apiVersion": "[variables('workbookApiVersion')]",
      "dependsOn": [
        "[variables('workspaceResourceId')]"
      ],
      "properties": {
        "displayName": "[concat(parameters('workbook1-name'), ' - ', parameters('formattedTimeNow'))]",
        "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Cisco Umbrella Overview\\nCisco Umbrella is a cloud security platform that provides the first line of defense against threats on the internet. This workbook helps you analyze events from your Cisco Umbrella logs.\\n\\n**NOTE**: This workbook depends on a parser based on a Kusto Function to work as expected [**Cisco_Umbrella**](https://aka.ms/sentinel-ciscoumbrella-parser) which is deployed with the Sentinel Solution.\",\"style\":\"info\"},\"name\":\"text - 2\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"400e5dcf-3925-494b-a74f-7fc9c9c7d212\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"isRequired\":true,\"value\":{\"durationMs\":604800000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":604800000},{\"durationMs\":2592000000},{\"durationMs\":7776000000}]},\"timeContext\":{\"durationMs\":86400000}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cisco_Umbrella\\r\\n| make-series TotalEvents = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain};\",\"size\":0,\"title\":\"Events over time\",\"color\":\"blue\",\"timeContext\":{\"durationMs\":604800000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"linechart\"},\"customWidth\":\"50\",\"name\":\"query - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cisco_Umbrella\\r\\n| where isnotempty(EventType)\\r\\n| summarize TotalEvents = count() by EventType\\r\\n| sort by TotalEvents desc\",\"size\":3,\"title\":\"Events by Type\",\"timeContext\":{\"durationMs\":604800000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"50\",\"name\":\"query - 4\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cisco_Umbrella\\r\\n| where isnotempty(DvcAction)\\r\\n| summarize Count = count() by DvcAction\\r\\n| sort by Count desc\",\"size\":3,\"title\":\"Actions Distribution\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"33\",\"name\":\"query - 5\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cisco_Umbrella\\r\\n| where isnotempty(UrlCategory)\\r\\n| extend URLCategories = split(UrlCategory, \\\",\\\")\\r\\n| mv-expand URLCategory = URLCategories to typeof(string)\\r\\n| where URLCategory != \\\"\\\"\\r\\n| summarize Count = count() by tostring(URLCategory)\\r\\n| order by Count desc\\r\\n| top 10 by Count\",\"size\":3,\"title\":\"Top URL Categories\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\"},\"customWidth\":\"33\",\"name\":\"query - 8\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cisco_Umbrella\\r\\n| where isnotempty(ThreatCategory)\\r\\n| extend BlockedCategories = split(ThreatCategory, \\\",\\\")\\r\\n| mv-expand BlockedCategory = BlockedCategories to typeof(string)\\r\\n| where BlockedCategory != \\\"\\\"\\r\\n| summarize Count = count() by tostring(BlockedCategory)\\r\\n| order by Count desc\",\"size\":3,\"title\":\"Threats by Category\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\"},\"customWidth\":\"33\",\"name\":\"query - 9\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cisco_Umbrella\\r\\n| where isnotempty(SrcIpAddr)\\r\\n| summarize count() by SrcIpAddr\\r\\n| top 10 by count_ desc\\r\\n| project ['Source IP'] = SrcIpAddr, ['Event Count'] = count_\",\"size\":0,\"title\":\"Top Source IPs\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Event Count\",\"formatter\":4,\"formatOptions\":{\"palette\":\"blue\"}}]}},\"customWidth\":\"33\",\"name\":\"query - 10\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cisco_Umbrella\\r\\n| where EventType =~ \\\"proxylogs\\\"\\r\\n| where DvcAction == \\\"BLOCKED\\\"\\r\\n| where isnotempty(UrlOriginal)\\r\\n| summarize Count = count() by UrlOriginal\\r\\n| top 10 by Count desc\",\"size\":0,\"title\":\"Top Blocked URLs\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Count\",\"formatter\":4,\"formatOptions\":{\"palette\":\"red\"}}]}},\"customWidth\":\"33\",\"name\":\"query - 11\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cisco_Umbrella\\r\\n| where EventType =~ \\\"proxylogs\\\"\\r\\n| where isnotempty(Identities)\\r\\n| summarize Count = count() by Identities\\r\\n| top 10 by Count desc\",\"size\":0,\"title\":\"Top Active Users/Identities\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Count\",\"formatter\":4,\"formatOptions\":{\"palette\":\"blue\"}}]}},\"customWidth\":\"33\",\"name\":\"query - 12\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cisco_Umbrella\\r\\n| where EventType =~ \\\"dnslogs\\\"\\r\\n| where isnotempty(DnsQueryName)\\r\\n| summarize QueryCount = count() by DnsQueryName\\r\\n| top 15 by QueryCount desc\",\"size\":1,\"title\":\"Top DNS Queries\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\"},\"customWidth\":\"50\",\"name\":\"query - 13\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cisco_Umbrella\\r\\n| where EventType =~ \\\"proxylogs\\\"\\r\\n| where isnotempty(HttpUserAgentOriginal)\\r\\n| summarize Count = count() by HttpUserAgentOriginal\\r\\n| top 10 by Count desc\",\"size\":0,\"title\":\"Top User Agents\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Count\",\"formatter\":4,\"formatOptions\":{\"palette\":\"blue\"}}]}},\"customWidth\":\"50\",\"name\":\"query - 14\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cisco_Umbrella\\r\\n| where EventType =~ \\\"proxylogs\\\" and DvcAction == \\\"BLOCKED\\\"\\r\\n| where isnotempty(HttpUserAgentOriginal)\\r\\n| summarize Count = count() by HttpUserAgentOriginal\\r\\n| top 10 by Count desc\",\"size\":0,\"title\":\"Top User Agents for Blocked Requests\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Count\",\"formatter\":4,\"formatOptions\":{\"palette\":\"red\"}}]}},\"customWidth\":\"50\",\"name\":\"query - 15\"}],\"styleSettings\":{},\"fromTemplateId\":\"sentinel-CiscoUmbrellaWorkbook\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}",
        "version": "1.0",
        "sourceId": "[variables('workspaceResourceId')]",
        "category": "sentinel"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
      "apiVersion": "[variables('savedSearchApiVersion')]",
      "name": "[concat(parameters('workspace'), '/Cisco Umbrella Hunting Query 1')]",
      "dependsOn": [
        "[variables('workspaceResourceId')]"
      ],
      "properties": {
        "eTag": "*",
        "displayName": "Cisco Umbrella - Anomalous FQDNs for domain",
        "category": "Hunting Queries",
        "query": "Cisco_Umbrella\n| where TimeGenerated > ago(24h)\n| where EventType == 'dnslogs'\n| extend replaced = replace(@'\\.$', @'', DnsQueryName)\n| extend Domain = extract(@'.*\\.(.*\\.[a-z]+)', 1, replaced)\n| extend fqdn = extract(@'(.*)\\..*\\.[a-z]+', 1, replaced)\n| summarize FQDNs = dcount(fqdn) by Domain\n| sort by FQDNs\n",
        "version": 1,
        "tags": [
          {
            "name": "description",
            "value": "Large number of FQDNs for domain may be indicator of suspicious domain."
          },
          {
            "name": "tactics",
            "value": "CommandandControl"
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
      "apiVersion": "[variables('savedSearchApiVersion')]",
      "name": "[concat(parameters('workspace'), '/Cisco Umbrella Hunting Query 2')]",
      "dependsOn": [
        "[variables('workspaceResourceId')]"
      ],
      "properties": {
        "eTag": "*",
        "displayName": "Cisco Umbrella - 'Blocked' User-Agents.",
        "category": "Hunting Queries",
        "query": "Cisco_Umbrella\n| where TimeGenerated > ago(24h)\n| where DvcAction =~ 'Blocked'\n| summarize count() by HttpUserAgentOriginal\n| sort by count_\n",
        "version": 1,
        "tags": [
          {
            "name": "description",
            "value": "Shows User-Agent values which requests were blocked"
          },
          {
            "name": "tactics",
            "value": "Exfiltration"
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
      "apiVersion": "[variables('savedSearchApiVersion')]",
      "name": "[concat(parameters('workspace'), '/Cisco Umbrella Hunting Query 3')]",
      "dependsOn": [
        "[variables('workspaceResourceId')]"
      ],
      "properties": {
        "eTag": "*",
        "displayName": "Cisco Umbrella - DNS Errors.",
        "category": "Hunting Queries",
        "query": "Cisco_Umbrella\n| where TimeGenerated > ago(24h)\n| where EventType == 'dnslogs'\n| where DnsResponseCodeName != 'NOERROR'\n| extend URLCustomEntity = UrlOriginal\n| extend AccountCustomEntity = Identities\n| extend IPCustomEntity = SrcIpAddr\n",
        "version": 1,
        "tags": [
          {
            "name": "description",
            "value": "Shows error DNS requests."
          },
          {
            "name": "tactics",
            "value": "InitialAccess"
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
      "apiVersion": "[variables('savedSearchApiVersion')]",
      "name": "[concat(parameters('workspace'), '/Cisco Umbrella Hunting Query 4')]",
      "dependsOn": [
        "[variables('workspaceResourceId')]"
      ],
      "properties": {
        "eTag": "*",
        "displayName": "Cisco Umbrella - DNS requests to unreliable categories.",
        "category": "Hunting Queries",
        "query": "Cisco_Umbrella\n| where TimeGenerated > ago(24h)\n| where EventType == 'dnslogs'\n| where UrlCategory contains 'Dating' or UrlCategory contains 'Digital Postcards' or UrlCategory contains 'Freeware and Shareware' or UrlCategory contains 'Gambling' or UrlCategory contains  'Hacking' or UrlCategory contains 'Hunting' or UrlCategory contains 'Mobile Phones' or UrlCategory contains 'Software Updates' or UrlCategory contains 'URL Shortener' or UrlCategory contains  'Web Hosting'\n| where DvcAction == 'Allowed'\n| summarize TotalEvents = count() by DnsQueryName, SrcIpAddr\n| sort by TotalEvents\n| summarize listOfIps = make_set(SrcIpAddr) by DnsQueryName\n| extend URLCustomEntity = DnsQueryName\n",
        "version": 1,
        "tags": [
          {
            "name": "description",
            "value": "Shows requests to URI categories which heavily are used in Initial Access stage by threat actiors and may contain malicious content."
          },
          {
            "name": "tactics",
            "value": "InitialAccess"
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
      "apiVersion": "[variables('savedSearchApiVersion')]",
      "name": "[concat(parameters('workspace'), '/Cisco Umbrella Hunting Query 5')]",
      "dependsOn": [
        "[variables('workspaceResourceId')]"
      ],
      "properties": {
        "eTag": "*",
        "displayName": "Cisco Umbrella - Higher values of count of the Same BytesIn size",
        "category": "Hunting Queries",
        "query": "let timeframe = 1d;\nCisco_Umbrella \n| where EventType == \"proxylogs\"\n| where TimeGenerated > ago(timeframe)\n| summarize count() by SrcIpAddr,DstIpAddr, SrcBytes\n| sort by count_ desc\n| extend Message = \"Possible communication with C2\"\n| project Message, SrcIpAddr, DstIpAddr\n| extend IpCustomEntity = SrcIpAddr\n",
        "version": 1,
        "tags": [
          {
            "name": "description",
            "value": "Calculate the count of BytesIn per Source-Destination pair over 24 hours. Higher values may indicate beaconing."
          },
          {
            "name": "tactics",
            "value": "CommandandControl"
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
      "apiVersion": "[variables('savedSearchApiVersion')]",
      "name": "[concat(parameters('workspace'), '/Cisco Umbrella Hunting Query 6')]",
      "dependsOn": [
        "[variables('workspaceResourceId')]"
      ],
      "properties": {
        "eTag": "*",
        "displayName": "Cisco Umbrella - High values of Uploaded Data",
        "category": "Hunting Queries",
        "query": "let timeframe = 1d;\nCisco_Umbrella \n| where EventType == \"proxylogs\"\n| where TimeGenerated > ago(timeframe)\n| summarize sum(DstBytes) by SrcIpAddr,DstIpAddr\n| sort by sum_DstBytes desc\n| project SrcIpAddr, DstIpAddr\n| extend IpCustomEntity = SrcIpAddr\n",
        "version": 1,
        "tags": [
          {
            "name": "description",
            "value": "A normal user activity consists mostly of downloading data. Uploaded data is usually small unless there is a file/data upload to a website. Calculate the sum of BytesOut per Source-Destination pair over 12/24 hours."
          },
          {
            "name": "tactics",
            "value": "Exfiltration"
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
      "apiVersion": "[variables('savedSearchApiVersion')]",
      "name": "[concat(parameters('workspace'), '/Cisco Umbrella Hunting Query 7')]",
      "dependsOn": [
        "[variables('workspaceResourceId')]"
      ],
      "properties": {
        "eTag": "*",
        "displayName": "Cisco Umbrella - Possible connection to C2.",
        "category": "Hunting Queries",
        "query": "let timeframe = 1d;\nCisco_Umbrella \n| where EventType == \"proxylogs\"\n| where TimeGenerated > ago(timeframe)\n| summarize count() by SrcIpAddr, DstIpAddr, SrcBytes\n| sort by count_ desc\n| extend Message = \"Possible communication with C2\"\n| extend IPCustomEntity = SrcIpAddr\n",
        "version": 1,
        "tags": [
          {
            "name": "description",
            "value": "Calculate the count of BytesIn per Source-Destination pair over 12/24 hours. Higher values may indicate beaconing. C2 servers reply with the same data, making BytesIn value the same."
          },
          {
            "name": "tactics",
            "value": "CommandandControl"
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
      "apiVersion": "[variables('savedSearchApiVersion')]",
      "name": "[concat(parameters('workspace'), '/Cisco Umbrella Hunting Query 8')]",
      "dependsOn": [
        "[variables('workspaceResourceId')]"
      ],
      "properties": {
        "eTag": "*",
        "displayName": "Cisco Umbrella - Possible data exfiltration",
        "category": "Hunting Queries",
        "query": "let timeframe = 1d;\nCisco_Umbrella \n| where EventType == \"proxylogs\"\n| where TimeGenerated > ago(timeframe)\n| summarize sum(DstBytes) by SrcIpAddr,DstIpAddr\n| sort by sum_DstBytes desc\n| extend Message = \"Possible data exfiltration\"\n| extend IPCustomEntity = SrcIpAddr\n",
        "version": 1,
        "tags": [
          {
            "name": "description",
            "value": "A normal user activity consists mostly of downloading data. Uploaded data is usually small unless there is a file/data upload to a website. Calculate the sum of BytesOut per Source-Destination pair over 12/24 hours."
          },
          {
            "name": "tactics",
            "value": "Exfiltration"
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
      "apiVersion": "[variables('savedSearchApiVersion')]",
      "name": "[concat(parameters('workspace'), '/Cisco Umbrella Hunting Query 9')]",
      "dependsOn": [
        "[variables('workspaceResourceId')]"
      ],
      "properties": {
        "eTag": "*",
        "displayName": "Cisco Umbrella - Proxy 'Allowed' to unreliable categories.",
        "category": "Hunting Queries",
        "query": "Cisco_Umbrella\n| where TimeGenerated > ago(24h)\n| where EventType == 'proxylogs'\n| where UrlCategory contains 'Dating' or UrlCategory contains 'Digital Postcards' or UrlCategory contains 'Freeware and Shareware' or UrlCategory contains 'Gambling' or UrlCategory contains  'Hacking' or UrlCategory contains 'Hunting' or UrlCategory contains 'Mobile Phones' or UrlCategory contains 'Software Updates' or UrlCategory contains 'URL Shortener' or UrlCategory contains  'Web Hosting'\n| where DvcAction == 'ALLOWED'\n| summarize TotalEvents = count() by UrlOriginal, SrcIpAddr\n| sort by TotalEvents\n| summarize listOfIps = make_set(SrcIpAddr) by UrlOriginal\n| extend URLCustomEntity = UrlOriginal\n",
        "version": 1,
        "tags": [
          {
            "name": "description",
            "value": "Shows allowed requests to URI categories which heavily are used in Initial Access stage by threat actiors and may contain malicious content."
          },
          {
            "name": "tactics",
            "value": "InitialAccess"
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
      "apiVersion": "[variables('savedSearchApiVersion')]",
      "name": "[concat(parameters('workspace'), '/Cisco Umbrella Hunting Query 10')]",
      "dependsOn": [
        "[variables('workspaceResourceId')]"
      ],
      "properties": {
        "eTag": "*",
        "displayName": "Cisco Umbrella - Requests to uncategorized resources",
        "category": "Hunting Queries",
        "query": "Cisco_Umbrella\n| where TimeGenerated > ago(24h)\n| where DvcAction =~ 'Allowed'\n| where UrlCategory == ''\n| project UrlOriginal, Identities\n| extend URLCustomEntity = UrlOriginal\n| extend AccountCustomEntity = Identities\n",
        "version": 1,
        "tags": [
          {
            "name": "description",
            "value": "Shows requests to URL where UrlCategory is not set."
          },
          {
            "name": "tactics",
            "value": "InitialAccess"
          }
        ]
      }
    }
  ],
  "outputs": {}
}
